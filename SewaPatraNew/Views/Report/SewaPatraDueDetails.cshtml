@using DevExtreme.AspNet.Mvc
@{
    ViewData["Title"] = "Sewapatra Due Report";
}
@model List<SewaPatra.Models.ReportModels.SewaPatraDueReport>
<section class="section">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <div class="pagetitle mt-2">
                        <h1>Sewapatra Due Report</h1>
                        <nav>
                            <ol class="breadcrumb">
                                @* <li class="breadcrumb-item"><a href="index.html">Home</a></li> *@
                                <li class="breadcrumb-item">Report</li>
                                <li class="breadcrumb-item active">Sewapatra Due Report</li>
                            </ol>
                        </nav>
                    </div>
                    <div id="gridContainer">
                        @(Html.DevExtreme().DataGrid()
                            .ID("SewaPatraDueReport")
                            .ShowBorders(true)
                            .DataSource(Model)
                            .KeyExpr("Id")
                            .RemoteOperations(false)
                            .AllowColumnReordering(true)
                            .RowAlternationEnabled(true)
                            .Width("100%")
                            .Paging(prop => prop.PageSize(10))
                            .Pager(p => p.Visible(true)
                            .ShowPageSizeSelector(true)
                            .AllowedPageSizes(new[] { 10, 25, 50, 100 }))
                            .SearchPanel(s => s.Visible(true).HighlightCaseSensitive(true))
                            .GroupPanel(g => g.Visible(true))
                            .Grouping(g => g.AutoExpandAll(false))
                            .AllowColumnResizing(true)
                            .ColumnHidingEnabled(true)
                            .ColumnChooser(c => c.Enabled(true))
                            .Sorting(sorting => sorting.Mode(GridSortingMode.Multiple))
                            .Export(e => e
                            .Enabled(true)
                            .Formats(new[] { "xlsx" })
                            )
                            .OnExporting("exportToExcel")
                            .Columns(c =>
                            {
                                c.Add().DataField("SNo").Width(45).HeaderCellTemplate(@<text><div style="text-align: center;font-weight:bold;color:black;">SNo</div></text>);
                                c.Add().DataField("DonationBox").HeaderCellTemplate(@<text><div style="text-align: center;font-weight:bold;color:black;">DonationBox</div></text>);
                                c.Add().DataField("IssueDate").HeaderCellTemplate(@<text><div style="text-align: center;font-weight:bold;color:black;">IssueDate</div></text>);
                                c.Add().DataField("DonorName").HeaderCellTemplate(@<text><div style="text-align: center;font-weight:bold;color:black;">DonorName</div></text>);
                                c.Add().DataField("DonorArea").HeaderCellTemplate(@<text><div style="text-align: center;font-weight:bold;color:black;">DonorArea</div></text>);
                                c.Add().DataField("DueDate").HeaderCellTemplate(@<text><div style="text-align: center;font-weight:bold;color:black;">DueDate</div></text>);
                                c.Add().DataField("Coordinator").HeaderCellTemplate(@<text><div style="text-align: center;font-weight:bold;color:black;">Coordinator</div></text>);
                            })
                            )
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
         function showColumnChooser(e) {
            e.component.showColumnChooser();
        }
    function filterReport() {
        var fromDate = document.getElementById("fromDate").value || null;
        var toDate = document.getElementById("toDate").value || null;

        // Function to format date in "YYYY-MM-DD HH:mm:ss.fff"
        function formatDateTime(dateString, isEndOfDay = false) {
            if (!dateString) return null;
            let date = new Date(dateString);
            let year = date.getFullYear();
            let month = String(date.getMonth() + 1).padStart(2, "0"); // Month is zero-based
            let day = String(date.getDate()).padStart(2, "0");
            let hours = isEndOfDay ? "23" : "00"; // Start of day or End of day
            let minutes = isEndOfDay ? "59" : "00";
            let seconds = isEndOfDay ? "59" : "00";
            let milliseconds = isEndOfDay ? "999" : "000";
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
        }

        // Format dates
        fromDate = formatDateTime(fromDate);
        toDate = formatDateTime(toDate, true); // End of day

        // AJAX request to the MasterController
        $.ajax({
                url: '@Url.Action("SewaPatraDueReport", "Report")',
            type: 'GET',
            data: {
                fromDate: fromDate,
                toDate: toDate
            },
            success: function (response) {
                var dataGrid = $("#SewaPatraDueReport").dxDataGrid("instance");
                dataGrid.option("dataSource", response);
            },
            error: function (xhr, status, error) {
                alert("There was an error while fetching the data: " + error);
            }
        });
    }
         function exportToExcel(e) {
            if (e.format === "xlsx") {
                // Excel export (your existing code)
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('SewaPatraDueReport');
                DevExpress.excelExporter.exportDataGrid({
                    component: e.component,
                    worksheet: worksheet,
                    autoFilterEnabled: true,
                    customizeCell: function(options) {
                        if (options.gridCell.rowType === "header") {
                            options.font = { bold: true };
                        }
                    }
                }).then(function() {
                    workbook.xlsx.writeBuffer().then(function(buffer) {
                        saveAs(new Blob([buffer], { type: "application/octet-stream" }), "SewaPatraDueReport.xlsx");
                    });
                });
                e.cancel = true;
            }
            else if (e.format === "pdf") {
                // PDF export (using pdfmake)
                DevExpress.pdfExporter.exportDataGrid({
                    component: e.component,
                    customizeDoc: function(doc) {
                        doc.pageMargins = [20, 20, 20, 20]; // Margins (left, top, right, bottom)
                        doc.defaultStyle = { fontSize: 10 };
                        // Adjust table widths to match your column count (11 columns)
                        doc.content[0].table.widths = Array(11).fill('*');
                    }
                }).then(function(buffer) {
                    saveAs(new Blob([buffer], { type: "application/pdf" }), "SewaPatraDueReport.pdf");
                });
                e.cancel = true;
            }
        }

</script>